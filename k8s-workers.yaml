- name: Set up Kubernetes control-plane
  hosts: master
  become: true
  tasks:
    - name: Install containerd
      apt:
        name: ['containerd.io']
        state: latest
        update_cache: yes
      
    - name: Config containerd
      shell: sudo containerd config default | sudo tee /etc/containerd/config.toml > /dev/null && sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml

    - name: Configure worker nodes to join Kubernetes cluster
      hosts: kube_node
      become: true
      tasks:
        - name: Add Kubernetes GPG key
          apt_key:
            url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
            state: present

        - name: Add Kubernetes repository
          apt_repository:
            repo: "deb http://apt.kubernetes.io/ kubernetes-xenial main"
            state: present

        - name: Install kubeadm and kubelet
          apt:
            name: ['kubeadm', 'kubelet']
            state: present

        - name: Join Kubernetes cluster
          command: "{{ hostvars['master']['kubeadm_join_cmd'][0] }}"